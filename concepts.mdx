---
title: "Core Concepts"
description: "Understanding environments, templates, seeds, runs, and diffs"
---

## Overview

Agent Diff uses a few key abstractions to enable deterministic agent testing:

```
┌────────────────────────────────────────────────────────────────────────┐
│                           TEMPLATE                                      │
│  A reusable schema with seed data (e.g., slack_default)                │
│  └── Contains: users, channels, messages, etc.                         │
└───────────────────────────────┬────────────────────────────────────────┘
                                │
                                │ clone
                                ▼
┌────────────────────────────────────────────────────────────────────────┐
│                          ENVIRONMENT                                    │
│  Isolated, ephemeral copy of a template                                │
│  └── Has: unique ID, TTL, schema_name, service URL                     │
└───────────────────────────────┬────────────────────────────────────────┘
                                │
                                │ start_run
                                ▼
┌────────────────────────────────────────────────────────────────────────┐
│                             RUN                                         │
│  A test session within an environment                                  │
│  └── Tracks: before snapshot, after snapshot, diff                     │
└───────────────────────────────┬────────────────────────────────────────┘
                                │
                                │ agent actions
                                ▼
┌────────────────────────────────────────────────────────────────────────┐
│                             DIFF                                        │
│  The computed state changes                                            │
│  └── Contains: inserts, updates, deletes                               │
└────────────────────────────────────────────────────────────────────────┘
```

---

## Templates

Templates are pre-configured database schemas that serve as starting points for test environments. Think of them as **snapshots of a service's state** that your agent will interact with.

### What's in a Template?

- **Schema**: Database structure (tables, columns, constraints)
- **Seed Data**: Initial data (users, channels, messages, issues, etc.)
- **Service**: Which API the template implements (Slack, Linear)

### Built-in Templates

| Template | Service | Description |
|----------|---------|-------------|
| `slack_default` | Slack | 3 users, 2 channels, 3 messages |
| `slack_bench_default` | Slack | Extended seed for benchmarks |
| `linear_default` | Linear | Basic teams, users, issues |
| `linear_expanded` | Linear | Full seed with projects, cycles, workflows |

### Exploring Template Contents

To see exactly what data is inside a template, check the seed files in the repo:

<Tabs>
  <Tab title="Slack Templates">
    **Location**: `examples/slack/seeds/`
    
    | File | Template | Contents |
    |------|----------|----------|
    | `slack_default.json` | slack_default | 3 users, 2 channels (#general, #random), 3 messages |
    | `slack_bench_default.json` | slack_bench_default | Extended with threads, reactions, DMs |
    
    **Key entities:**
    - `users` - User accounts with IDs like `U01AGENBOT9`
    - `channels` - Channels with IDs like `C01GENERAL99`
    - `channel_members` - Who belongs to which channel
    - `messages` - Pre-seeded messages with timestamps
    - `reactions` - Emoji reactions on messages
  </Tab>
  <Tab title="Linear Templates">
    **Location**: `examples/linear/seeds/`
    
    | File | Template | Contents |
    |------|----------|----------|
    | `linear_default.json` | linear_default | 2 teams, 3 users, 5 issues |
    | `linear_expanded.json` | linear_expanded | Full workspace with 40+ entities |
    
    **Key entities:**
    - `organizations` - Org with ID
    - `teams` - Engineering (ENG), Growth (GRO)
    - `users` - Team members
    - `workflow_states` - Backlog, In Progress, Done
    - `issues` - Pre-seeded issues like ENG-1, ENG-2
    - `issue_labels` - Labels like "bug", "feature"
    - `comments` - Issue comments
  </Tab>
</Tabs>

<Tip>
**View seed files on GitHub**: [slack seeds](https://github.com/hubertpysklo/agent-diff/tree/main/examples/slack/seeds) | [linear seeds](https://github.com/hubertpysklo/agent-diff/tree/main/examples/linear/seeds)
</Tip>

### Using Templates

```python
# List all available templates
templates = client.list_templates()
for t in templates.templates:
    print(f"{t.name} ({t.service}) - {t.description}")

# Use a built-in template
env = client.init_env(
    templateService="slack",
    templateName="slack_default",
    impersonateUserId="U01AGENBOT9"  # Must exist in the template!
)
```

### Querying Template Data

Once you create an environment, you can query it to see what's inside:

```python
import requests

env = client.init_env(
    templateService="slack",
    templateName="slack_default",
    impersonateUserId="U01AGENBOT9"
)

# List all channels in the environment
response = requests.get(f"{env.environmentUrl}/conversations.list")
channels = response.json()["channels"]
for ch in channels:
    print(f"#{ch['name']} ({ch['id']})")

# List all users
response = requests.get(f"{env.environmentUrl}/users.list")
users = response.json()["members"]
for u in users:
    print(f"@{u['name']} ({u['id']})")
```

### Creating Custom Templates

You can create a template from any environment:

```python
# Create an environment and customize it
env = client.init_env(templateService="slack", templateName="slack_default")

# Make changes via API (add users, channels, etc.)
import requests
requests.post(f"{env.environmentUrl}/conversations.create", json={
    "name": "engineering"
})
requests.post(f"{env.environmentUrl}/chat.postMessage", json={
    "channel": "C01GENERAL99",
    "text": "Custom seed message!"
})

# Save as a new template
custom = client.create_template_from_environment(
    environmentId=env.environmentId,
    service="slack",
    name="my_custom_template",
    description="My customized Slack workspace",
    visibility="private"  # Only visible to you
)
```

---

## Environments

Environments are isolated, ephemeral copies of templates where your agents operate.

### Key Properties

| Property | Description |
|----------|-------------|
| `environmentId` | Unique identifier (UUID) |
| `environmentUrl` | Base URL for API calls |
| `schemaName` | PostgreSQL schema name |
| `expiresAt` | Auto-cleanup time (based on TTL) |
| `status` | `ready`, `expired`, `deleted` |

### Lifecycle

```python
# 1. Create environment (clones from template)
env = client.init_env(
    templateService="slack",
    templateName="slack_default",
    impersonateUserId="U01AGENBOT9",  # Which user the agent acts as
    ttlSeconds=3600  # Expires in 1 hour
)

# 2. Use environment for API calls
# env.environmentUrl → http://localhost:8000/api/env/{id}/services/slack

# 3. Clean up (or let TTL expire)
client.delete_env(envId=env.environmentId)
```

### Isolation

Each environment has:
- **Separate database schema**: No cross-contamination between tests
- **Independent state**: Changes don't affect other environments or templates
- **Own API endpoint**: Unique URL for routing agent requests

---

## Runs

A run represents a single test session within an environment.

### Run Lifecycle

<Steps>
  <Step title="Start Run">
    Takes a "before" snapshot of the environment state
    ```python
    run = client.start_run(envId=env.environmentId)
    ```
  </Step>
  
  <Step title="Agent Execution">
    Your agent makes API calls that modify the environment
  </Step>
  
  <Step title="Compute Diff">
    Compares before/after states to produce a diff
    ```python
    result = client.diff_run(runId=run.runId)
    ```
  </Step>
  
  <Step title="Evaluate (Optional)">
    Check if the diff matches expected assertions
    ```python
    evaluation = client.evaluate_run(runId=run.runId)
    ```
  </Step>
</Steps>

### Run Properties

| Property | Description |
|----------|-------------|
| `runId` | Unique identifier |
| `status` | `running`, `completed`, `failed` |
| `beforeSnapshot` | Snapshot ID before agent execution |
| `afterSnapshot` | Snapshot ID after agent execution |

---

## Diffs

A diff is the computed difference between the before and after states of an environment.

### Structure

```json
{
  "inserts": [
    {
      "__table__": "messages",
      "message_id": "1732645891.000200",
      "channel_id": "C01GENERAL99",
      "user_id": "U01AGENBOT9",
      "message_text": "Hello World!"
    }
  ],
  "updates": [
    {
      "__table__": "channels",
      "before": { "last_message_at": null },
      "after": { "last_message_at": "2025-11-26T15:31:31" }
    }
  ],
  "deletes": []
}
```

### Diff Types

<CardGroup cols={3}>
  <Card title="Inserts" icon="plus">
    New records created by the agent
  </Card>
  <Card title="Updates" icon="pen">
    Existing records modified (shows before/after)
  </Card>
  <Card title="Deletes" icon="trash">
    Records removed by the agent
  </Card>
</CardGroup>

### How Diffs Are Captured

Agent Diff uses PostgreSQL logical replication to capture every change:

1. **WAL Capture**: All database writes are logged to the Write-Ahead Log
2. **wal2json**: Converts WAL entries to JSON format
3. **Change Journal**: Filtered and stored per environment/run
4. **Diff Computation**: Aggregated into inserts/updates/deletes

<Note>
This approach captures changes at the database level, so it works regardless of which API endpoint the agent used.
</Note>

---

## Seeds

Seeds are JSON files that define the initial data for a template.

### Example: Slack Seed

```json
{
  "users": [
    {
      "user_id": "U01AGENBOT9",
      "username": "agent_bot",
      "display_name": "Agent Bot",
      "email": "agent@example.com"
    },
    {
      "user_id": "U02JOHNDOE1",
      "username": "john.doe",
      "display_name": "John Doe",
      "email": "john@example.com"
    }
  ],
  "channels": [
    {
      "channel_id": "C01GENERAL99",
      "name": "general",
      "is_private": false
    }
  ],
  "channel_members": [
    { "channel_id": "C01GENERAL99", "user_id": "U01AGENBOT9" },
    { "channel_id": "C01GENERAL99", "user_id": "U02JOHNDOE1" }
  ],
  "messages": [
    {
      "message_id": "1732645800.000100",
      "channel_id": "C01GENERAL99",
      "user_id": "U02JOHNDOE1",
      "message_text": "Welcome to the team!"
    }
  ]
}
```

### Seed Location

Seeds are stored in the `examples/` directory:
- `examples/slack/seeds/` - Slack seed files
- `examples/linear/seeds/` - Linear seed files

---

## Putting It Together

```python
from agent_diff import AgentDiff, PythonExecutorProxy, create_openai_tool
from agents import Agent, Runner

client = AgentDiff()

# 1. Create environment from template
env = client.init_env(
    templateService="slack",
    templateName="slack_default",
    impersonateUserId="U01AGENBOT9"
)

# 2. Start a run (captures before state)
run = client.start_run(envId=env.environmentId)

# 3. Create executor and agent
executor = PythonExecutorProxy(env.environmentId, client.base_url)
agent = Agent(
    name="Slack Assistant",
    tools=[create_openai_tool(executor)],
    instructions="Use execute_python to interact with Slack at https://slack.com/api/*"
)

# 4. Run agent
await Runner.run(agent, "Post 'Hello' to #general")

# 5. Get diff
diff = client.diff_run(runId=run.runId)
print(f"Created {len(diff.diff['inserts'])} records")

# 6. Cleanup
client.delete_env(envId=env.environmentId)
```

## Next Steps

<CardGroup cols={2}>
  <Card title="Code Executors" icon="code" href="/executors/how-it-works">
    Learn how API interception works
  </Card>
  <Card title="Evaluations" icon="check" href="/evaluations/overview">
    Add assertions and run benchmarks
  </Card>
</CardGroup>

